<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCZT Algorithm - Individual Editable SVGs</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            font-size: 2.2em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        .chart-title {
            font-size: 1.4em;
            font-weight: bold;
            color: #333;
        }
        .button-group {
            display: flex;
            gap: 10px;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        .svg-container {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        svg {
            max-width: 100%;
            height: auto;
            /* 阻止在拖动时触发默认的浏览器行为 */
            user-select: none;
        }
        text.editable {
            cursor: pointer;
        }
        text.editable:hover {
            fill: #667eea;
        }
        .instruction {
            background: rgba(255,255,255,0.95);
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .instruction h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .instruction p {
            color: #666;
            line-height: 1.8;
            margin: 5px 0;
        }
        /* 新增样式：拖动时改变光标，提高用户体验 */
        text.editable.dragging {
            cursor: grabbing !important;
            fill: #764ba2 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎯 MCZT Algorithm Visualization</h1>

        <div class="instruction">
            <h3>📝 如何使用:</h3>
            <p><strong>1.</strong> 点击 <strong>"✏️ Edit"</strong> 按钮开启该图的编辑模式。</p>
            <p><strong>2.</strong> <strong>点击</strong> 任何文本来修改内容（将出现一个提示框）。</p>
            <p><strong>3.</strong> **按住并拖动** 任何文本来移动它的位置。</p>
            <p><strong>4.</strong> 点击 <strong>"📥 Download"</strong> 保存 SVG 文件。</p>
            <p><strong>5.</strong> 每个图表都可以独立编辑和下载。</p>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <div class="chart-title">Step 1: FFT Coarse Localization</div>
                <div class="button-group">
                    <button onclick="toggleEdit('fft')">✏️ Edit</button>
                    <button onclick="downloadSVG('fft-svg', 'FFT_Coarse_Localization.svg')">📥 Download</button>
                </div>
            </div>
            <div class="svg-container">
                <svg id="fft-svg" viewBox="0 0 600 400" xmlns="http://www.w3.org/2000/svg">
                    <rect width="600" height="400" fill="white"/>

                    <text x="300" y="35" text-anchor="middle" font-size="18" fill="#667eea" font-weight="bold" class="editable fft-edit">FFT Spectrum</text>

                    <g stroke="#e8e8e8" stroke-width="1">
                        <line x1="80" y1="330" x2="550" y2="330"/>
                        <line x1="80" y1="275" x2="550" y2="275" stroke-dasharray="3,3"/>
                        <line x1="80" y1="220" x2="550" y2="220" stroke-dasharray="3,3"/>
                        <line x1="80" y1="165" x2="550" y2="165" stroke-dasharray="3,3"/>
                        <line x1="80" y1="110" x2="550" y2="110" stroke-dasharray="3,3"/>
                    </g>

                    <g id="fft-bars"></g>

                    <line x1="337" y1="135" x2="337" y2="330" stroke="red" stroke-width="2.5" stroke-dasharray="5,5"/>
                    <circle cx="337" cy="137" r="7" fill="red"/>
                    <line x1="80" y1="330" x2="550" y2="330" stroke="black" stroke-width="2"/>
                    <line x1="80" y1="330" x2="80" y2="85" stroke="black" stroke-width="2"/>

                    <text x="315" y="365" text-anchor="middle" font-size="16" fill="#333" font-weight="500" class="editable fft-edit">Frequency (kHz)</text>
                    <text x="45" y="210" text-anchor="middle" font-size="16" fill="#333" font-weight="500" transform="rotate(-90 45 210)" class="editable fft-edit">Magnitude</text>
                    <text x="335" y="75" text-anchor="middle" font-size="13" fill="red" font-weight="bold" class="editable fft-edit">True Frequency</text>
                </svg>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <div class="chart-title">Step 2: Macleod Coarse Estimation</div>
                <div class="button-group">
                    <button onclick="toggleEdit('macleod')">✏️ Edit</button>
                    <button onclick="downloadSVG('macleod-svg', 'Macleod_Coarse_Estimation.svg')">📥 Download</button>
                </div>
            </div>
            <div class="svg-container">
                <svg id="macleod-svg" viewBox="0 0 600 350" xmlns="http://www.w3.org/2000/svg">
                    <rect width="600" height="350" fill="white"/>

                    <g stroke="#e8e8e8" stroke-width="1">
                        <line x1="80" y1="280" x2="550" y2="280"/>
                        <line x1="80" y1="230" x2="550" y2="230" stroke-dasharray="3,3"/>
                        <line x1="80" y1="180" x2="550" y2="180" stroke-dasharray="3,3"/>
                        <line x1="80" y1="130" x2="550" y2="130" stroke-dasharray="3,3"/>
                        <line x1="80" y1="80" x2="550" y2="80" stroke-dasharray="3,3"/>
                    </g>

                    <rect x="200" y="170" width="80" height="110" fill="#ffd93d" opacity="0.85"/>
                    <rect x="310" y="120" width="80" height="160" fill="#fdcb6e" opacity="0.9"/>
                    <rect x="420" y="195" width="80" height="85" fill="#ffd93d" opacity="0.85"/>

                    <path d="M 240 170 Q 350 90 460 195" stroke="#e17055" stroke-width="3.5" fill="none"/>

                    <circle cx="365" cy="95" r="7" fill="red"/>
                    <line x1="365" y1="95" x2="365" y2="280" stroke="red" stroke-width="2" stroke-dasharray="4,4"/>

                    <line x1="80" y1="280" x2="550" y2="280" stroke="black" stroke-width="2"/>
                    <line x1="80" y1="280" x2="80" y2="60" stroke="black" stroke-width="2"/>

                    <text x="315" y="315" text-anchor="middle" font-size="16" fill="#333" font-weight="500" class="editable macleod-edit">Frequency Bins</text>
                    <text x="45" y="170" text-anchor="middle" font-size="16" fill="#333" font-weight="500" transform="rotate(-90 45 170)" class="editable macleod-edit">Magnitude</text>
                    <text x="240" y="305" text-anchor="middle" font-size="14" fill="#666" class="editable macleod-edit">k-1</text>
                    <text x="350" y="305" text-anchor="middle" font-size="14" fill="#666" class="editable macleod-edit">k</text>
                    <text x="460" y="305" text-anchor="middle" font-size="14" fill="#666" class="editable macleod-edit">k+1</text>
                    <text x="365" y="80" text-anchor="middle" font-size="13" fill="red" font-weight="bold" class="editable macleod-edit">Interpolated Peak</text>
                    <text x="300" y="40" text-anchor="middle" font-size="18" fill="#e17055" font-weight="bold" class="editable macleod-edit">Parabolic Interpolation</text>
                </svg>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <div class="chart-title">Step 3: CZT Local Refinement</div>
                <div class="button-group">
                    <button onclick="toggleEdit('czt')">✏️ Edit</button>
                    <button onclick="downloadSVG('czt-svg', 'CZT_Local_Refinement.svg')">📥 Download</button>
                </div>
            </div>
            <div class="svg-container">
                <svg id="czt-svg" viewBox="0 0 600 350" xmlns="http://www.w3.org/2000/svg">
                    <rect width="600" height="350" fill="white"/>

                    <g stroke="#e8e8e8" stroke-width="1">
                        <line x1="80" y1="280" x2="550" y2="280"/>
                        <line x1="80" y1="230" x2="550" y2="230" stroke-dasharray="3,3"/>
                        <line x1="80" y1="180" x2="550" y2="180" stroke-dasharray="3,3"/>
                        <line x1="80" y1="130" x2="550" y2="130" stroke-dasharray="3,3"/>
                        <line x1="80" y1="80" x2="550" y2="80" stroke-dasharray="3,3"/>
                    </g>

                    <g id="czt-bars"></g>

                    <circle cx="345" cy="85" r="7" fill="red"/>
                    <line x1="345" y1="85" x2="345" y2="280" stroke="red" stroke-width="2" stroke-dasharray="4,4"/>

                    <line x1="80" y1="280" x2="550" y2="280" stroke="black" stroke-width="2"/>
                    <line x1="80" y1="280" x2="80" y2="60" stroke="black" stroke-width="2"/>

                    <text x="315" y="315" text-anchor="middle" font-size="16" fill="#333" font-weight="500" class="editable czt-edit">Frequency (High Resolution)</text>
                    <text x="45" y="170" text-anchor="middle" font-size="16" fill="#333" font-weight="500" transform="rotate(-90 45 170)" class="editable czt-edit">Magnitude</text>
                    <text x="345" y="70" text-anchor="middle" font-size="13" fill="red" font-weight="bold" class="editable czt-edit">CZT Peak</text>
                    <text x="300" y="40" text-anchor="middle" font-size="18" fill="#00b894" font-weight="bold" class="editable czt-edit">CZT Spectrum</text>
                </svg>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <div class="chart-title">Step 4: Macleod Fine Estimation</div>
                <div class="button-group">
                    <button onclick="toggleEdit('final')">✏️ Edit</button>
                    <button onclick="downloadSVG('final-svg', 'Macleod_Fine_Estimation.svg')">📥 Download</button>
                </div>
            </div>
            <div class="svg-container">
                <svg id="final-svg" viewBox="0 0 600 350" xmlns="http://www.w3.org/2000/svg">
                    <rect width="600" height="350" fill="white"/>

                    <g stroke="#e8e8e8" stroke-width="1">
                        <line x1="80" y1="280" x2="550" y2="280"/>
                        <line x1="80" y1="230" x2="550" y2="230" stroke-dasharray="3,3"/>
                        <line x1="80" y1="180" x2="550" y2="180" stroke-dasharray="3,3"/>
                        <line x1="80" y1="130" x2="550" y2="130" stroke-dasharray="3,3"/>
                        <line x1="80" y1="80" x2="550" y2="80" stroke-dasharray="3,3"/>
                    </g>

                    <rect x="180" y="150" width="65" height="130" fill="#ff9a76" opacity="0.8"/>
                    <rect x="260" y="120" width="65" height="160" fill="#ff9a76" opacity="0.85"/>
                    <rect x="340" y="90" width="65" height="190" fill="#e17055" opacity="0.9"/>
                    <rect x="420" y="120" width="65" height="160" fill="#ff9a76" opacity="0.85"/>
                    <rect x="500" y="150" width="65" height="130" fill="#ff9a76" opacity="0.8"/>

                    <path d="M 212 150 Q 372 60 532 150" stroke="#764ba2" stroke-width="3.5" fill="none"/>

                    <circle cx="385" cy="68" r="8" fill="red" stroke="white" stroke-width="2.5"/>
                    <line x1="385" y1="68" x2="385" y2="280" stroke="red" stroke-width="2" stroke-dasharray="4,4"/>

                    <line x1="80" y1="280" x2="550" y2="280" stroke="black" stroke-width="2"/>
                    <line x1="80" y1="280" x2="80" y2="60" stroke="black" stroke-width="2"/>

                    <text x="315" y="315" text-anchor="middle" font-size="16" fill="#333" font-weight="500" class="editable final-edit">CZT Frequency Bins</text>
                    <text x="45" y="170" text-anchor="middle" font-size="16" fill="#333" font-weight="500" transform="rotate(-90 45 170)" class="editable final-edit">Magnitude</text>
                    <text x="385" y="50" text-anchor="middle" font-size="14" fill="red" font-weight="bold" class="editable final-edit">f_MCZT</text>
                    <text x="300" y="40" text-anchor="middle" font-size="18" fill="#d63031" font-weight="bold" class="editable final-edit">Final Estimation</text>
                </svg>
            </div>
        </div>
    </div>

    <script>
        const editStates = {
            fft: false,
            macleod: false,
            czt: false,
            final: false
        };

        // 用于拖动的全局状态
        let selectedElement = null;
        let offset = { x: 0, y: 0 };
        let dragStartTime = 0;
        const DRAG_THRESHOLD = 200; // 毫秒，用于区分点击和拖动

        // --- 拖动逻辑函数 ---

        function getMousePosition(evt, svgElement) {
            // 获取 SVG 相对于视口的边界框
            const CTM = svgElement.getScreenCTM();
            // 根据 SVG 的变换矩阵将鼠标坐标转换为 SVG 坐标
            return {
                x: (evt.clientX - CTM.e) / CTM.a,
                y: (evt.clientY - CTM.f) / CTM.d
            };
        }

        function startDrag(evt) {
            const textElement = evt.target;
            // 确保只在编辑模式下响应
            const figureType = textElement.classList.contains('fft-edit') ? 'fft' :
                               textElement.classList.contains('macleod-edit') ? 'macleod' :
                               textElement.classList.contains('czt-edit') ? 'czt' :
                               textElement.classList.contains('final-edit') ? 'final' : null;

            if (figureType && editStates[figureType]) {
                evt.preventDefault(); // 阻止默认的拖动行为
                selectedElement = textElement;
                dragStartTime = Date.now();
                selectedElement.classList.add('dragging');

                // 找到最近的 SVG 元素
                const svgElement = selectedElement.closest('svg');
                if (!svgElement) return;

                // 获取鼠标在 SVG 坐标系中的位置
                const currentMouse = getMousePosition(evt, svgElement);

                // 只有没有 transform 属性的 text 元素才能直接设置 x/y，
                // 否则需要通过 transform: translate() 来移动，这里我们只处理 x/y
                if (selectedElement.hasAttribute('transform')) {
                     // 对于有旋转的文本，移动比较复杂，这里为了简洁，仅支持无旋转的文本。
                     // 如果要支持旋转文本移动，需要使用 SVGMatrix 进行更复杂的计算。
                    alert("⚠️ 带有 'transform' 属性的文本（如旋转的轴标签）不支持直接拖动。");
                    endDrag();
                    return;
                }

                // 计算偏移量
                const startX = parseFloat(selectedElement.getAttributeNS(null, "x") || 0);
                const startY = parseFloat(selectedElement.getAttributeNS(null, "y") || 0);
                offset = {
                    x: currentMouse.x - startX,
                    y: currentMouse.y - startY
                };

                // 在 SVG 父元素上添加 move 和 end 监听器，确保拖出 SVG 也能停止
                svgElement.addEventListener('mousemove', drag, false);
                svgElement.addEventListener('mouseup', endDrag, false);
                // 添加全局监听，以防鼠标离开SVG后松开
                document.addEventListener('mouseleave', endDrag, false);
            }
        }

        function drag(evt) {
            if (selectedElement) {
                evt.preventDefault();

                const svgElement = selectedElement.closest('svg');
                if (!svgElement) return;

                const currentMouse = getMousePosition(evt, svgElement);

                // 更新 x 和 y 属性
                const newX = currentMouse.x - offset.x;
                const newY = currentMouse.y - offset.y;
                selectedElement.setAttributeNS(null, "x", newX);
                selectedElement.setAttributeNS(null, "y", newY);
            }
        }

        function endDrag() {
            if (selectedElement) {
                // 移除 dragging 样式
                selectedElement.classList.remove('dragging');

                // 移除事件监听器
                const svgElement = selectedElement.closest('svg');
                if (svgElement) {
                    svgElement.removeEventListener('mousemove', drag, false);
                    svgElement.removeEventListener('mouseup', endDrag, false);
                }
                document.removeEventListener('mouseleave', endDrag, false);

                selectedElement = null;
            }
        }

        // --- 文本内容编辑逻辑 (修改以兼容拖动) ---

        function makeEditable(event) {
            // 只有当拖动时间非常短（被认为是纯粹的点击）时，才触发编辑提示
            if (Date.now() - dragStartTime < DRAG_THRESHOLD && !selectedElement) {
                const textElement = event.target;
                const originalText = textElement.textContent;
                const newText = prompt('编辑文本:', originalText);

                if (newText !== null && newText.trim() !== '') {
                    textElement.textContent = newText;
                }
            }
            dragStartTime = 0; // 重置时间
        }

        // --- 初始化和控制逻辑 ---

        // Toggle edit mode for specific figure
        function toggleEdit(figureType) {
            editStates[figureType] = !editStates[figureType];
            const className = figureType + '-edit';
            const texts = document.querySelectorAll('.' + className);

            if (editStates[figureType]) {
                texts.forEach(text => {
                    // 绑定拖动开始事件
                    text.addEventListener('mousedown', startDrag);
                    // 绑定内容编辑事件 (click event)
                    text.addEventListener('click', makeEditable);
                    // 调整光标提示可拖动和点击编辑
                    text.style.cursor = 'move';
                });
                alert(`✏️ ${figureType.toUpperCase()} 的编辑模式已启用！现在可以点击编辑文本内容，或按住并拖动来移动文本。`);
            } else {
                texts.forEach(text => {
                    text.removeEventListener('mousedown', startDrag);
                    text.removeEventListener('click', makeEditable);
                    text.style.cursor = 'pointer'; // 恢复默认光标
                });
                endDrag(); // 确保退出编辑模式时停止任何正在进行的拖动
                alert(`👁️ ${figureType.toUpperCase()} 的查看模式已启用。`);
            }
        }

        // --- 原始辅助函数 ---

        // Generate FFT bars
        function generateFFTBars() {
            const container = document.getElementById('fft-bars');
            container.innerHTML = '';
            const barCount = 32;
            const startX = 80;
            const width = 470;
            const barWidth = width / barCount;
            const peakIndex = 17;

            for (let i = 0; i < barCount; i++) {
                const barHeight = Math.max(10, 180 * Math.exp(-Math.pow(i - peakIndex, 2) / 20));
                const x = startX + i * barWidth;
                const y = 330 - barHeight; // 从 330 开始

                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', x + 1);
                rect.setAttribute('y', y);
                rect.setAttribute('width', barWidth - 2);
                rect.setAttribute('height', barHeight);
                rect.setAttribute('fill', i === peakIndex ? '#667eea' : '#a8edea');
                rect.setAttribute('opacity', '0.85');
                container.appendChild(rect);
            }
        }

        // Generate CZT bars
        function generateCZTBars() {
            const container = document.getElementById('czt-bars');
            container.innerHTML = '';
            const barCount = 38;
            const startX = 80;
            const width = 470;
            const barWidth = width / barCount;
            const peakIndex = 21;

            for (let i = 0; i < barCount; i++) {
                const barHeight = Math.max(10, 195 * Math.exp(-Math.pow(i - peakIndex, 2) / 18));
                const x = startX + i * barWidth;
                const y = 280 - barHeight;

                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', x + 0.5);
                rect.setAttribute('y', y);
                rect.setAttribute('width', barWidth - 1);
                rect.setAttribute('height', barHeight);
                rect.setAttribute('fill', i === peakIndex ? '#00b894' : '#6bcf7f');
                rect.setAttribute('opacity', '0.85');
                container.appendChild(rect);
            }
        }

        // Download SVG
        function downloadSVG(svgId, filename) {
            const svg = document.getElementById(svgId);
            const serializer = new XMLSerializer();
            let source = serializer.serializeToString(svg);

            if (!source.match(/^<svg[^>]+xmlns="http:\/\/www\.w3\.org\/2000\/svg"/)) {
                source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
            }
            if (!source.match(/^<svg[^>]+"http:\/\/www\.w3\.org\/1999\/xlink"/)) {
                source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
            }

            source = '<?xml version="1.0" standalone="no"?>\r\n' + source;

            const url = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(source);
            const link = document.createElement("a");
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Initialize
        generateFFTBars();
        generateCZTBars();
    </script>
</body>
</html>