<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCZT Algorithm - Individual Editable SVGs</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: white;
            margin-bottom: 40px;
            font-size: 2.2em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .chart-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        .chart-title {
            font-size: 1.4em;
            font-weight: bold;
            color: #333;
        }
        .button-group {
            display: flex;
            gap: 10px;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        .svg-container {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        svg {
            max-width: 100%;
            height: auto;
            /* é˜»æ­¢åœ¨æ‹–åŠ¨æ—¶è§¦å‘é»˜è®¤çš„æµè§ˆå™¨è¡Œä¸º */
            user-select: none;
        }
        text.editable {
            cursor: pointer;
        }
        text.editable:hover {
            fill: #667eea;
        }
        .instruction {
            background: rgba(255,255,255,0.95);
            border-left: 4px solid #667eea;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .instruction h3 {
            color: #667eea;
            margin-bottom: 10px;
        }
        .instruction p {
            color: #666;
            line-height: 1.8;
            margin: 5px 0;
        }
        /* æ–°å¢æ ·å¼ï¼šæ‹–åŠ¨æ—¶æ”¹å˜å…‰æ ‡ï¼Œæé«˜ç”¨æˆ·ä½“éªŒ */
        text.editable.dragging {
            cursor: grabbing !important;
            fill: #764ba2 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ MCZT Algorithm Visualization</h1>

        <div class="instruction">
            <h3>ğŸ“ å¦‚ä½•ä½¿ç”¨:</h3>
            <p><strong>1.</strong> ç‚¹å‡» <strong>"âœï¸ Edit"</strong> æŒ‰é’®å¼€å¯è¯¥å›¾çš„ç¼–è¾‘æ¨¡å¼ã€‚</p>
            <p><strong>2.</strong> <strong>ç‚¹å‡»</strong> ä»»ä½•æ–‡æœ¬æ¥ä¿®æ”¹å†…å®¹ï¼ˆå°†å‡ºç°ä¸€ä¸ªæç¤ºæ¡†ï¼‰ã€‚</p>
            <p><strong>3.</strong> **æŒ‰ä½å¹¶æ‹–åŠ¨** ä»»ä½•æ–‡æœ¬æ¥ç§»åŠ¨å®ƒçš„ä½ç½®ã€‚</p>
            <p><strong>4.</strong> ç‚¹å‡» <strong>"ğŸ“¥ Download"</strong> ä¿å­˜ SVG æ–‡ä»¶ã€‚</p>
            <p><strong>5.</strong> æ¯ä¸ªå›¾è¡¨éƒ½å¯ä»¥ç‹¬ç«‹ç¼–è¾‘å’Œä¸‹è½½ã€‚</p>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <div class="chart-title">Step 1: FFT Coarse Localization</div>
                <div class="button-group">
                    <button onclick="toggleEdit('fft')">âœï¸ Edit</button>
                    <button onclick="downloadSVG('fft-svg', 'FFT_Coarse_Localization.svg')">ğŸ“¥ Download</button>
                </div>
            </div>
            <div class="svg-container">
                <svg id="fft-svg" viewBox="0 0 600 400" xmlns="http://www.w3.org/2000/svg">
                    <rect width="600" height="400" fill="white"/>

                    <text x="300" y="35" text-anchor="middle" font-size="18" fill="#667eea" font-weight="bold" class="editable fft-edit">FFT Spectrum</text>

                    <g stroke="#e8e8e8" stroke-width="1">
                        <line x1="80" y1="330" x2="550" y2="330"/>
                        <line x1="80" y1="275" x2="550" y2="275" stroke-dasharray="3,3"/>
                        <line x1="80" y1="220" x2="550" y2="220" stroke-dasharray="3,3"/>
                        <line x1="80" y1="165" x2="550" y2="165" stroke-dasharray="3,3"/>
                        <line x1="80" y1="110" x2="550" y2="110" stroke-dasharray="3,3"/>
                    </g>

                    <g id="fft-bars"></g>

                    <line x1="337" y1="135" x2="337" y2="330" stroke="red" stroke-width="2.5" stroke-dasharray="5,5"/>
                    <circle cx="337" cy="137" r="7" fill="red"/>
                    <line x1="80" y1="330" x2="550" y2="330" stroke="black" stroke-width="2"/>
                    <line x1="80" y1="330" x2="80" y2="85" stroke="black" stroke-width="2"/>

                    <text x="315" y="365" text-anchor="middle" font-size="16" fill="#333" font-weight="500" class="editable fft-edit">Frequency (kHz)</text>
                    <text x="45" y="210" text-anchor="middle" font-size="16" fill="#333" font-weight="500" transform="rotate(-90 45 210)" class="editable fft-edit">Magnitude</text>
                    <text x="335" y="75" text-anchor="middle" font-size="13" fill="red" font-weight="bold" class="editable fft-edit">True Frequency</text>
                </svg>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <div class="chart-title">Step 2: Macleod Coarse Estimation</div>
                <div class="button-group">
                    <button onclick="toggleEdit('macleod')">âœï¸ Edit</button>
                    <button onclick="downloadSVG('macleod-svg', 'Macleod_Coarse_Estimation.svg')">ğŸ“¥ Download</button>
                </div>
            </div>
            <div class="svg-container">
                <svg id="macleod-svg" viewBox="0 0 600 350" xmlns="http://www.w3.org/2000/svg">
                    <rect width="600" height="350" fill="white"/>

                    <g stroke="#e8e8e8" stroke-width="1">
                        <line x1="80" y1="280" x2="550" y2="280"/>
                        <line x1="80" y1="230" x2="550" y2="230" stroke-dasharray="3,3"/>
                        <line x1="80" y1="180" x2="550" y2="180" stroke-dasharray="3,3"/>
                        <line x1="80" y1="130" x2="550" y2="130" stroke-dasharray="3,3"/>
                        <line x1="80" y1="80" x2="550" y2="80" stroke-dasharray="3,3"/>
                    </g>

                    <rect x="200" y="170" width="80" height="110" fill="#ffd93d" opacity="0.85"/>
                    <rect x="310" y="120" width="80" height="160" fill="#fdcb6e" opacity="0.9"/>
                    <rect x="420" y="195" width="80" height="85" fill="#ffd93d" opacity="0.85"/>

                    <path d="M 240 170 Q 350 90 460 195" stroke="#e17055" stroke-width="3.5" fill="none"/>

                    <circle cx="365" cy="95" r="7" fill="red"/>
                    <line x1="365" y1="95" x2="365" y2="280" stroke="red" stroke-width="2" stroke-dasharray="4,4"/>

                    <line x1="80" y1="280" x2="550" y2="280" stroke="black" stroke-width="2"/>
                    <line x1="80" y1="280" x2="80" y2="60" stroke="black" stroke-width="2"/>

                    <text x="315" y="315" text-anchor="middle" font-size="16" fill="#333" font-weight="500" class="editable macleod-edit">Frequency Bins</text>
                    <text x="45" y="170" text-anchor="middle" font-size="16" fill="#333" font-weight="500" transform="rotate(-90 45 170)" class="editable macleod-edit">Magnitude</text>
                    <text x="240" y="305" text-anchor="middle" font-size="14" fill="#666" class="editable macleod-edit">k-1</text>
                    <text x="350" y="305" text-anchor="middle" font-size="14" fill="#666" class="editable macleod-edit">k</text>
                    <text x="460" y="305" text-anchor="middle" font-size="14" fill="#666" class="editable macleod-edit">k+1</text>
                    <text x="365" y="80" text-anchor="middle" font-size="13" fill="red" font-weight="bold" class="editable macleod-edit">Interpolated Peak</text>
                    <text x="300" y="40" text-anchor="middle" font-size="18" fill="#e17055" font-weight="bold" class="editable macleod-edit">Parabolic Interpolation</text>
                </svg>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <div class="chart-title">Step 3: CZT Local Refinement</div>
                <div class="button-group">
                    <button onclick="toggleEdit('czt')">âœï¸ Edit</button>
                    <button onclick="downloadSVG('czt-svg', 'CZT_Local_Refinement.svg')">ğŸ“¥ Download</button>
                </div>
            </div>
            <div class="svg-container">
                <svg id="czt-svg" viewBox="0 0 600 350" xmlns="http://www.w3.org/2000/svg">
                    <rect width="600" height="350" fill="white"/>

                    <g stroke="#e8e8e8" stroke-width="1">
                        <line x1="80" y1="280" x2="550" y2="280"/>
                        <line x1="80" y1="230" x2="550" y2="230" stroke-dasharray="3,3"/>
                        <line x1="80" y1="180" x2="550" y2="180" stroke-dasharray="3,3"/>
                        <line x1="80" y1="130" x2="550" y2="130" stroke-dasharray="3,3"/>
                        <line x1="80" y1="80" x2="550" y2="80" stroke-dasharray="3,3"/>
                    </g>

                    <g id="czt-bars"></g>

                    <circle cx="345" cy="85" r="7" fill="red"/>
                    <line x1="345" y1="85" x2="345" y2="280" stroke="red" stroke-width="2" stroke-dasharray="4,4"/>

                    <line x1="80" y1="280" x2="550" y2="280" stroke="black" stroke-width="2"/>
                    <line x1="80" y1="280" x2="80" y2="60" stroke="black" stroke-width="2"/>

                    <text x="315" y="315" text-anchor="middle" font-size="16" fill="#333" font-weight="500" class="editable czt-edit">Frequency (High Resolution)</text>
                    <text x="45" y="170" text-anchor="middle" font-size="16" fill="#333" font-weight="500" transform="rotate(-90 45 170)" class="editable czt-edit">Magnitude</text>
                    <text x="345" y="70" text-anchor="middle" font-size="13" fill="red" font-weight="bold" class="editable czt-edit">CZT Peak</text>
                    <text x="300" y="40" text-anchor="middle" font-size="18" fill="#00b894" font-weight="bold" class="editable czt-edit">CZT Spectrum</text>
                </svg>
            </div>
        </div>

        <div class="chart-card">
            <div class="chart-header">
                <div class="chart-title">Step 4: Macleod Fine Estimation</div>
                <div class="button-group">
                    <button onclick="toggleEdit('final')">âœï¸ Edit</button>
                    <button onclick="downloadSVG('final-svg', 'Macleod_Fine_Estimation.svg')">ğŸ“¥ Download</button>
                </div>
            </div>
            <div class="svg-container">
                <svg id="final-svg" viewBox="0 0 600 350" xmlns="http://www.w3.org/2000/svg">
                    <rect width="600" height="350" fill="white"/>

                    <g stroke="#e8e8e8" stroke-width="1">
                        <line x1="80" y1="280" x2="550" y2="280"/>
                        <line x1="80" y1="230" x2="550" y2="230" stroke-dasharray="3,3"/>
                        <line x1="80" y1="180" x2="550" y2="180" stroke-dasharray="3,3"/>
                        <line x1="80" y1="130" x2="550" y2="130" stroke-dasharray="3,3"/>
                        <line x1="80" y1="80" x2="550" y2="80" stroke-dasharray="3,3"/>
                    </g>

                    <rect x="180" y="150" width="65" height="130" fill="#ff9a76" opacity="0.8"/>
                    <rect x="260" y="120" width="65" height="160" fill="#ff9a76" opacity="0.85"/>
                    <rect x="340" y="90" width="65" height="190" fill="#e17055" opacity="0.9"/>
                    <rect x="420" y="120" width="65" height="160" fill="#ff9a76" opacity="0.85"/>
                    <rect x="500" y="150" width="65" height="130" fill="#ff9a76" opacity="0.8"/>

                    <path d="M 212 150 Q 372 60 532 150" stroke="#764ba2" stroke-width="3.5" fill="none"/>

                    <circle cx="385" cy="68" r="8" fill="red" stroke="white" stroke-width="2.5"/>
                    <line x1="385" y1="68" x2="385" y2="280" stroke="red" stroke-width="2" stroke-dasharray="4,4"/>

                    <line x1="80" y1="280" x2="550" y2="280" stroke="black" stroke-width="2"/>
                    <line x1="80" y1="280" x2="80" y2="60" stroke="black" stroke-width="2"/>

                    <text x="315" y="315" text-anchor="middle" font-size="16" fill="#333" font-weight="500" class="editable final-edit">CZT Frequency Bins</text>
                    <text x="45" y="170" text-anchor="middle" font-size="16" fill="#333" font-weight="500" transform="rotate(-90 45 170)" class="editable final-edit">Magnitude</text>
                    <text x="385" y="50" text-anchor="middle" font-size="14" fill="red" font-weight="bold" class="editable final-edit">f_MCZT</text>
                    <text x="300" y="40" text-anchor="middle" font-size="18" fill="#d63031" font-weight="bold" class="editable final-edit">Final Estimation</text>
                </svg>
            </div>
        </div>
    </div>

    <script>
        const editStates = {
            fft: false,
            macleod: false,
            czt: false,
            final: false
        };

        // ç”¨äºæ‹–åŠ¨çš„å…¨å±€çŠ¶æ€
        let selectedElement = null;
        let offset = { x: 0, y: 0 };
        let dragStartTime = 0;
        const DRAG_THRESHOLD = 200; // æ¯«ç§’ï¼Œç”¨äºåŒºåˆ†ç‚¹å‡»å’Œæ‹–åŠ¨

        // --- æ‹–åŠ¨é€»è¾‘å‡½æ•° ---

        function getMousePosition(evt, svgElement) {
            // è·å– SVG ç›¸å¯¹äºè§†å£çš„è¾¹ç•Œæ¡†
            const CTM = svgElement.getScreenCTM();
            // æ ¹æ® SVG çš„å˜æ¢çŸ©é˜µå°†é¼ æ ‡åæ ‡è½¬æ¢ä¸º SVG åæ ‡
            return {
                x: (evt.clientX - CTM.e) / CTM.a,
                y: (evt.clientY - CTM.f) / CTM.d
            };
        }

        function startDrag(evt) {
            const textElement = evt.target;
            // ç¡®ä¿åªåœ¨ç¼–è¾‘æ¨¡å¼ä¸‹å“åº”
            const figureType = textElement.classList.contains('fft-edit') ? 'fft' :
                               textElement.classList.contains('macleod-edit') ? 'macleod' :
                               textElement.classList.contains('czt-edit') ? 'czt' :
                               textElement.classList.contains('final-edit') ? 'final' : null;

            if (figureType && editStates[figureType]) {
                evt.preventDefault(); // é˜»æ­¢é»˜è®¤çš„æ‹–åŠ¨è¡Œä¸º
                selectedElement = textElement;
                dragStartTime = Date.now();
                selectedElement.classList.add('dragging');

                // æ‰¾åˆ°æœ€è¿‘çš„ SVG å…ƒç´ 
                const svgElement = selectedElement.closest('svg');
                if (!svgElement) return;

                // è·å–é¼ æ ‡åœ¨ SVG åæ ‡ç³»ä¸­çš„ä½ç½®
                const currentMouse = getMousePosition(evt, svgElement);

                // åªæœ‰æ²¡æœ‰ transform å±æ€§çš„ text å…ƒç´ æ‰èƒ½ç›´æ¥è®¾ç½® x/yï¼Œ
                // å¦åˆ™éœ€è¦é€šè¿‡ transform: translate() æ¥ç§»åŠ¨ï¼Œè¿™é‡Œæˆ‘ä»¬åªå¤„ç† x/y
                if (selectedElement.hasAttribute('transform')) {
                     // å¯¹äºæœ‰æ—‹è½¬çš„æ–‡æœ¬ï¼Œç§»åŠ¨æ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œä¸ºäº†ç®€æ´ï¼Œä»…æ”¯æŒæ— æ—‹è½¬çš„æ–‡æœ¬ã€‚
                     // å¦‚æœè¦æ”¯æŒæ—‹è½¬æ–‡æœ¬ç§»åŠ¨ï¼Œéœ€è¦ä½¿ç”¨ SVGMatrix è¿›è¡Œæ›´å¤æ‚çš„è®¡ç®—ã€‚
                    alert("âš ï¸ å¸¦æœ‰ 'transform' å±æ€§çš„æ–‡æœ¬ï¼ˆå¦‚æ—‹è½¬çš„è½´æ ‡ç­¾ï¼‰ä¸æ”¯æŒç›´æ¥æ‹–åŠ¨ã€‚");
                    endDrag();
                    return;
                }

                // è®¡ç®—åç§»é‡
                const startX = parseFloat(selectedElement.getAttributeNS(null, "x") || 0);
                const startY = parseFloat(selectedElement.getAttributeNS(null, "y") || 0);
                offset = {
                    x: currentMouse.x - startX,
                    y: currentMouse.y - startY
                };

                // åœ¨ SVG çˆ¶å…ƒç´ ä¸Šæ·»åŠ  move å’Œ end ç›‘å¬å™¨ï¼Œç¡®ä¿æ‹–å‡º SVG ä¹Ÿèƒ½åœæ­¢
                svgElement.addEventListener('mousemove', drag, false);
                svgElement.addEventListener('mouseup', endDrag, false);
                // æ·»åŠ å…¨å±€ç›‘å¬ï¼Œä»¥é˜²é¼ æ ‡ç¦»å¼€SVGåæ¾å¼€
                document.addEventListener('mouseleave', endDrag, false);
            }
        }

        function drag(evt) {
            if (selectedElement) {
                evt.preventDefault();

                const svgElement = selectedElement.closest('svg');
                if (!svgElement) return;

                const currentMouse = getMousePosition(evt, svgElement);

                // æ›´æ–° x å’Œ y å±æ€§
                const newX = currentMouse.x - offset.x;
                const newY = currentMouse.y - offset.y;
                selectedElement.setAttributeNS(null, "x", newX);
                selectedElement.setAttributeNS(null, "y", newY);
            }
        }

        function endDrag() {
            if (selectedElement) {
                // ç§»é™¤ dragging æ ·å¼
                selectedElement.classList.remove('dragging');

                // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
                const svgElement = selectedElement.closest('svg');
                if (svgElement) {
                    svgElement.removeEventListener('mousemove', drag, false);
                    svgElement.removeEventListener('mouseup', endDrag, false);
                }
                document.removeEventListener('mouseleave', endDrag, false);

                selectedElement = null;
            }
        }

        // --- æ–‡æœ¬å†…å®¹ç¼–è¾‘é€»è¾‘ (ä¿®æ”¹ä»¥å…¼å®¹æ‹–åŠ¨) ---

        function makeEditable(event) {
            // åªæœ‰å½“æ‹–åŠ¨æ—¶é—´éå¸¸çŸ­ï¼ˆè¢«è®¤ä¸ºæ˜¯çº¯ç²¹çš„ç‚¹å‡»ï¼‰æ—¶ï¼Œæ‰è§¦å‘ç¼–è¾‘æç¤º
            if (Date.now() - dragStartTime < DRAG_THRESHOLD && !selectedElement) {
                const textElement = event.target;
                const originalText = textElement.textContent;
                const newText = prompt('ç¼–è¾‘æ–‡æœ¬:', originalText);

                if (newText !== null && newText.trim() !== '') {
                    textElement.textContent = newText;
                }
            }
            dragStartTime = 0; // é‡ç½®æ—¶é—´
        }

        // --- åˆå§‹åŒ–å’Œæ§åˆ¶é€»è¾‘ ---

        // Toggle edit mode for specific figure
        function toggleEdit(figureType) {
            editStates[figureType] = !editStates[figureType];
            const className = figureType + '-edit';
            const texts = document.querySelectorAll('.' + className);

            if (editStates[figureType]) {
                texts.forEach(text => {
                    // ç»‘å®šæ‹–åŠ¨å¼€å§‹äº‹ä»¶
                    text.addEventListener('mousedown', startDrag);
                    // ç»‘å®šå†…å®¹ç¼–è¾‘äº‹ä»¶ (click event)
                    text.addEventListener('click', makeEditable);
                    // è°ƒæ•´å…‰æ ‡æç¤ºå¯æ‹–åŠ¨å’Œç‚¹å‡»ç¼–è¾‘
                    text.style.cursor = 'move';
                });
                alert(`âœï¸ ${figureType.toUpperCase()} çš„ç¼–è¾‘æ¨¡å¼å·²å¯ç”¨ï¼ç°åœ¨å¯ä»¥ç‚¹å‡»ç¼–è¾‘æ–‡æœ¬å†…å®¹ï¼Œæˆ–æŒ‰ä½å¹¶æ‹–åŠ¨æ¥ç§»åŠ¨æ–‡æœ¬ã€‚`);
            } else {
                texts.forEach(text => {
                    text.removeEventListener('mousedown', startDrag);
                    text.removeEventListener('click', makeEditable);
                    text.style.cursor = 'pointer'; // æ¢å¤é»˜è®¤å…‰æ ‡
                });
                endDrag(); // ç¡®ä¿é€€å‡ºç¼–è¾‘æ¨¡å¼æ—¶åœæ­¢ä»»ä½•æ­£åœ¨è¿›è¡Œçš„æ‹–åŠ¨
                alert(`ğŸ‘ï¸ ${figureType.toUpperCase()} çš„æŸ¥çœ‹æ¨¡å¼å·²å¯ç”¨ã€‚`);
            }
        }

        // --- åŸå§‹è¾…åŠ©å‡½æ•° ---

        // Generate FFT bars
        function generateFFTBars() {
            const container = document.getElementById('fft-bars');
            container.innerHTML = '';
            const barCount = 32;
            const startX = 80;
            const width = 470;
            const barWidth = width / barCount;
            const peakIndex = 17;

            for (let i = 0; i < barCount; i++) {
                const barHeight = Math.max(10, 180 * Math.exp(-Math.pow(i - peakIndex, 2) / 20));
                const x = startX + i * barWidth;
                const y = 330 - barHeight; // ä» 330 å¼€å§‹

                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', x + 1);
                rect.setAttribute('y', y);
                rect.setAttribute('width', barWidth - 2);
                rect.setAttribute('height', barHeight);
                rect.setAttribute('fill', i === peakIndex ? '#667eea' : '#a8edea');
                rect.setAttribute('opacity', '0.85');
                container.appendChild(rect);
            }
        }

        // Generate CZT bars
        function generateCZTBars() {
            const container = document.getElementById('czt-bars');
            container.innerHTML = '';
            const barCount = 38;
            const startX = 80;
            const width = 470;
            const barWidth = width / barCount;
            const peakIndex = 21;

            for (let i = 0; i < barCount; i++) {
                const barHeight = Math.max(10, 195 * Math.exp(-Math.pow(i - peakIndex, 2) / 18));
                const x = startX + i * barWidth;
                const y = 280 - barHeight;

                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', x + 0.5);
                rect.setAttribute('y', y);
                rect.setAttribute('width', barWidth - 1);
                rect.setAttribute('height', barHeight);
                rect.setAttribute('fill', i === peakIndex ? '#00b894' : '#6bcf7f');
                rect.setAttribute('opacity', '0.85');
                container.appendChild(rect);
            }
        }

        // Download SVG
        function downloadSVG(svgId, filename) {
            const svg = document.getElementById(svgId);
            const serializer = new XMLSerializer();
            let source = serializer.serializeToString(svg);

            if (!source.match(/^<svg[^>]+xmlns="http:\/\/www\.w3\.org\/2000\/svg"/)) {
                source = source.replace(/^<svg/, '<svg xmlns="http://www.w3.org/2000/svg"');
            }
            if (!source.match(/^<svg[^>]+"http:\/\/www\.w3\.org\/1999\/xlink"/)) {
                source = source.replace(/^<svg/, '<svg xmlns:xlink="http://www.w3.org/1999/xlink"');
            }

            source = '<?xml version="1.0" standalone="no"?>\r\n' + source;

            const url = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(source);
            const link = document.createElement("a");
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Initialize
        generateFFTBars();
        generateCZTBars();
    </script>
</body>
</html>